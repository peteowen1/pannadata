name: Daily Understat Scrape

on:
  schedule:
    # Run at 7 AM UTC daily (after FBref scrape)
    - cron: '0 7 * * *'
  workflow_dispatch:
    inputs:
      lookback:
        description: 'IDs to look back from max (default: 20)'
        required: false
        type: string
        default: '20'
      max_misses:
        description: 'Stop after N consecutive misses per league (default: 50)'
        required: false
        type: string
        default: '50'
      force_rescrape:
        description: 'Rebuild manifest from scratch'
        required: false
        type: boolean
        default: false

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hour timeout

    permissions:
      contents: write  # Required for GitHub Releases upload

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
    - name: Checkout pannadata
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup R
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: 'release'

    - name: Install R dependencies
      run: |
        Rscript -e '
          # Use Posit Package Manager for pre-built Linux binaries (much faster)
          options(
            repos = c(
              CRAN = "https://packagemanager.posit.co/cran/__linux__/noble/latest"
            ),
            HTTPUserAgent = sprintf(
              "R/%s R (%s)",
              getRversion(),
              paste(getRversion(), R.version["platform"], R.version["arch"], R.version["os"])
            )
          )

          # Install packages (pre-built binaries from PPM)
          # Core panna dependencies + workflow requirements
          install.packages(c(
            "remotes", "piggyback", "httr", "httr2", "rvest",
            "arrow", "DBI", "duckdb", "cli",
            "data.table", "doParallel", "dplyr", "glmnet", "janitor",
            "tidyr", "lubridate", "magrittr", "Matrix", "purrr", "rlang",
            "jsonlite", "stringi"
          ))
        '
      shell: bash

    - name: Install panna package
      run: |
        Rscript -e 'remotes::install_github("peteowen1/panna@dev", dependencies = FALSE)'
      shell: bash

    - name: Download existing Understat data from GitHub Releases
      run: |
        Rscript -e '
          library(panna)

          # Set pannadata directory
          pannadata_dir(file.path(getwd(), "data"))

          tryCatch({
            pb_download_source(
              source_type = "understat",
              repo = "peteowen1/pannadata",
              dest = file.path(getwd(), "data"),
              verbose = TRUE
            )
            message("Downloaded existing Understat parquet data")
          }, error = function(e) {
            message("No existing Understat data (first run?): ", e$message)
            dir.create("data", recursive = TRUE, showWarnings = FALSE)
          })
        '
      shell: bash

    - name: Download manifest from GitHub Releases
      run: |
        echo "Downloading Understat manifest..."
        gh release download understat-latest \
          --pattern "understat-manifest.parquet" \
          --dir data/ \
          --repo peteowen1/pannadata 2>/dev/null || echo "No existing manifest found (first run)"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Build manifest from cache if needed
      run: |
        Rscript -e '
          library(panna)

          pannadata_dir(file.path(getwd(), "data"))
          manifest_path <- file.path(getwd(), "data", "understat-manifest.parquet")

          force_rebuild <- as.logical("${{ github.event.inputs.force_rescrape }}")
          if (is.na(force_rebuild)) force_rebuild <- FALSE

          if (force_rebuild || !file.exists(manifest_path)) {
            message("Building manifest from existing cache...")
            manifest <- build_understat_manifest_from_cache(file.path(getwd(), "data"))

            if (nrow(manifest) > 0) {
              save_understat_manifest(manifest, manifest_path)
              message(sprintf("Built manifest with %d matches", nrow(manifest)))

              # Show league breakdown
              message("\nLeague breakdown:")
              print(table(manifest$league))
            } else {
              message("No existing data to build manifest from")
            }
          } else {
            manifest <- load_understat_manifest(manifest_path)
            message(sprintf("Loaded existing manifest with %d matches", nrow(manifest)))
          }
        '
      shell: bash

    - name: Run smart Understat scraper
      run: |
        Rscript -e '
          library(panna)

          # Set pannadata directory
          pannadata_dir(file.path(getwd(), "data"))

          # Configuration from inputs
          lookback <- as.integer("${{ github.event.inputs.lookback }}")
          if (is.na(lookback)) lookback <- 20

          max_misses <- as.integer("${{ github.event.inputs.max_misses }}")
          if (is.na(max_misses)) max_misses <- 50

          manifest_path <- file.path(getwd(), "data", "understat-manifest.parquet")

          cat("\n", strrep("=", 60), "\n")
          cat("PANNA SMART UNDERSTAT SCRAPE\n")
          cat(strrep("=", 60), "\n\n")
          cat("Manifest path:", manifest_path, "\n")
          cat("Lookback:", lookback, "IDs\n")
          cat("Max misses per league:", max_misses, "\n")
          cat("Started:", format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n\n")

          # Run smart scraper with per-league tracking
          results <- smart_scrape_understat(
            manifest_path = manifest_path,
            leagues = c("RUS", "ENG", "ESP", "FRA", "ITA", "GER"),
            lookback = lookback,
            max_misses = max_misses,
            delay = 3,
            verbose = TRUE
          )

          # Summary
          cat("\n", strrep("=", 60), "\n")
          cat("SCRAPE SUMMARY\n")
          cat(strrep("=", 60), "\n")
          print(table(results$status))

          if (any(results$status == "success")) {
            cat("\nNew matches by league:\n")
            print(table(results$league[results$status == "success"]))
          }

          # Show manifest stats
          manifest <- load_understat_manifest(manifest_path)
          cat("\nManifest totals by league:\n")
          print(table(manifest$league))

          cat("\nFinished:", format(Sys.time(), "%Y-%m-%d %H:%M:%S"), "\n")
        '
      shell: bash

    - name: Build consolidated Understat parquet files
      run: |
        Rscript -e '
          library(panna)

          pannadata_dir(file.path(getwd(), "data"))

          # Check if we have any Understat data
          understat_dir <- file.path(getwd(), "data", "understat")
          if (!dir.exists(understat_dir)) {
            message("No Understat directory found")
            quit(status = 0)
          }

          message("Building consolidated Understat parquet files...")
          stats <- build_consolidated_understat_parquet(
            output_dir = file.path(getwd(), "data", "consolidated"),
            verbose = TRUE
          )

          if (nrow(stats) > 0) {
            message(sprintf("Built %d consolidated files (%.1f MB total)",
                            nrow(stats), sum(stats$size_mb)))
          }
        '
      shell: bash

    - name: Upload manifest to GitHub Releases
      run: |
        # Create release if it doesn't exist
        if ! gh release view understat-latest --repo peteowen1/pannadata >/dev/null 2>&1; then
          echo "Creating understat-latest release..."
          gh release create understat-latest \
            --repo peteowen1/pannadata \
            --title "Understat Data (Latest)" \
            --notes "Automated daily Understat data scrape with per-league tracking. Individual parquet files for fast remote queries." \
            --prerelease
        fi

        # Upload manifest
        if [ -f "data/understat-manifest.parquet" ]; then
          echo "Uploading manifest..."
          gh release upload understat-latest "data/understat-manifest.parquet" \
            --repo peteowen1/pannadata \
            --clobber
        fi
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload consolidated Understat parquet files to GitHub Releases
      run: |
        # Upload consolidated parquet files (understat_*.parquet)
        echo "Uploading consolidated Understat parquet files..."
        for f in data/consolidated/understat_*.parquet; do
          if [ -f "$f" ]; then
            fname=$(basename "$f")
            echo "  Uploading $fname..."
            gh release upload understat-latest "$f" \
              --repo peteowen1/pannadata \
              --clobber
          fi
        done

        echo "Individual Understat parquet uploads complete"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Understat parquet archive to GitHub Releases
      run: |
        Rscript -e '
          library(panna)

          pannadata_dir(file.path(getwd(), "data"))

          # Check if we have any Understat data
          understat_dir <- file.path(getwd(), "data", "understat")
          if (!dir.exists(understat_dir)) {
            message("No Understat directory found")
            quit(status = 0)
          }

          understat_files <- list.files(
            understat_dir,
            pattern = "\\.parquet$",
            recursive = TRUE
          )

          if (length(understat_files) == 0) {
            message("No Understat parquet files to upload")
            quit(status = 0)
          }

          message(sprintf("Found %d Understat parquet files", length(understat_files)))

          # Also upload the zip archive as backup
          pb_upload_source(
            source_type = "understat",
            repo = "peteowen1/pannadata",
            source = file.path(getwd(), "data"),
            verbose = TRUE
          )
        '
      shell: bash

    - name: Summary
      run: |
        echo "Daily Understat scrape completed successfully"
        echo "Check pannadata repo understat-latest release for updated data"
        echo ""
        echo "Manifest:"
        ls -lh data/understat-manifest.parquet 2>/dev/null || echo "  (none)"
        echo ""
        echo "Consolidated parquet files:"
        ls -lh data/consolidated/understat_*.parquet 2>/dev/null || echo "  (none)"
        echo ""
        echo "Total Understat parquet files: $(find data/understat -name '*.parquet' 2>/dev/null | wc -l)"
      shell: bash
